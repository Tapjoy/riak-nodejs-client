<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>lib/commands/kv/riakobject.js - basho-riak-client</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../assets/css/logo.png" title="basho-riak-client" width="117" height="52"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 2.2.2</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/AuthReq.html">AuthReq</a></li>
                                <li><a href="../classes/ByKeyBase.html">ByKeyBase</a></li>
                                <li><a href="../classes/ByKeyBase.Builder.html">ByKeyBase.Builder</a></li>
                                <li><a href="../classes/Client.html">Client</a></li>
                                <li><a href="../classes/CommandBase.html">CommandBase</a></li>
                                <li><a href="../classes/Delete.html">Delete</a></li>
                                <li><a href="../classes/Delete.Builder.html">Delete.Builder</a></li>
                                <li><a href="../classes/DeleteIndex.html">DeleteIndex</a></li>
                                <li><a href="../classes/DeleteIndex.Builder.html">DeleteIndex.Builder</a></li>
                                <li><a href="../classes/DeleteValue.html">DeleteValue</a></li>
                                <li><a href="../classes/DeleteValue.Builder.html">DeleteValue.Builder</a></li>
                                <li><a href="../classes/Describe.html">Describe</a></li>
                                <li><a href="../classes/Describe.Builder.html">Describe.Builder</a></li>
                                <li><a href="../classes/FetchBucketProps.html">FetchBucketProps</a></li>
                                <li><a href="../classes/FetchBucketProps.Builder.html">FetchBucketProps.Builder</a></li>
                                <li><a href="../classes/FetchBucketTypeProps.html">FetchBucketTypeProps</a></li>
                                <li><a href="../classes/FetchBucketTypeProps.Builder.html">FetchBucketTypeProps.Builder</a></li>
                                <li><a href="../classes/FetchCounter.html">FetchCounter</a></li>
                                <li><a href="../classes/FetchCounter.Builder.html">FetchCounter.Builder</a></li>
                                <li><a href="../classes/FetchIndex.html">FetchIndex</a></li>
                                <li><a href="../classes/FetchIndex.Builder.html">FetchIndex.Builder</a></li>
                                <li><a href="../classes/FetchMap.html">FetchMap</a></li>
                                <li><a href="../classes/FetchMap.Builder.html">FetchMap.Builder</a></li>
                                <li><a href="../classes/FetchPreflist.html">FetchPreflist</a></li>
                                <li><a href="../classes/FetchPreflist.Builder.html">FetchPreflist.Builder</a></li>
                                <li><a href="../classes/FetchPropsBase.html">FetchPropsBase</a></li>
                                <li><a href="../classes/FetchSchema.html">FetchSchema</a></li>
                                <li><a href="../classes/FetchSchema.Builder.html">FetchSchema.Builder</a></li>
                                <li><a href="../classes/FetchSet.html">FetchSet</a></li>
                                <li><a href="../classes/FetchSet.Builder.html">FetchSet.Builder</a></li>
                                <li><a href="../classes/FetchValue.html">FetchValue</a></li>
                                <li><a href="../classes/FetchValue.Builder.html">FetchValue.Builder</a></li>
                                <li><a href="../classes/Get.html">Get</a></li>
                                <li><a href="../classes/Get.Builder.html">Get.Builder</a></li>
                                <li><a href="../classes/LeastExecutingNodeManager.html">LeastExecutingNodeManager</a></li>
                                <li><a href="../classes/ListBuckets.html">ListBuckets</a></li>
                                <li><a href="../classes/ListBuckets.Builder.html">ListBuckets.Builder</a></li>
                                <li><a href="../classes/ListKeys.html">ListKeys</a></li>
                                <li><a href="../classes/ListKeys.Builder.html">ListKeys.Builder</a></li>
                                <li><a href="../classes/MapReduce.html">MapReduce</a></li>
                                <li><a href="../classes/NodeManager.html">NodeManager</a></li>
                                <li><a href="../classes/Ping.html">Ping</a></li>
                                <li><a href="../classes/Query.html">Query</a></li>
                                <li><a href="../classes/Query.Builder.html">Query.Builder</a></li>
                                <li><a href="../classes/ResetBucketProps.html">ResetBucketProps</a></li>
                                <li><a href="../classes/ResetBucketProps.Builder.html">ResetBucketProps.Builder</a></li>
                                <li><a href="../classes/RiakCluster.html">RiakCluster</a></li>
                                <li><a href="../classes/RiakCluster.Builder.html">RiakCluster.Builder</a></li>
                                <li><a href="../classes/RiakConnection.html">RiakConnection</a></li>
                                <li><a href="../classes/RiakNode.html">RiakNode</a></li>
                                <li><a href="../classes/RiakNode.Builder.html">RiakNode.Builder</a></li>
                                <li><a href="../classes/RiakObject.html">RiakObject</a></li>
                                <li><a href="../classes/RoundRobinNodeManager.html">RoundRobinNodeManager</a></li>
                                <li><a href="../classes/Search.html">Search</a></li>
                                <li><a href="../classes/Search.Builder.html">Search.Builder</a></li>
                                <li><a href="../classes/SecondaryIndexQuery.html">SecondaryIndexQuery</a></li>
                                <li><a href="../classes/SecondaryIndexQuery.Builder.html">SecondaryIndexQuery.Builder</a></li>
                                <li><a href="../classes/StartTls.html">StartTls</a></li>
                                <li><a href="../classes/Store.html">Store</a></li>
                                <li><a href="../classes/Store.Builder.html">Store.Builder</a></li>
                                <li><a href="../classes/StoreBucketProps.html">StoreBucketProps</a></li>
                                <li><a href="../classes/StoreBucketProps.Builder.html">StoreBucketProps.Builder</a></li>
                                <li><a href="../classes/StoreBucketTypeProps.html">StoreBucketTypeProps</a></li>
                                <li><a href="../classes/StoreBucketTypeProps.Builder.html">StoreBucketTypeProps.Builder</a></li>
                                <li><a href="../classes/StoreIndex.html">StoreIndex</a></li>
                                <li><a href="../classes/StoreIndex.Builder.html">StoreIndex.Builder</a></li>
                                <li><a href="../classes/StorePropsBase.html">StorePropsBase</a></li>
                                <li><a href="../classes/StoreSchema.html">StoreSchema</a></li>
                                <li><a href="../classes/StoreSchema.Builder.html">StoreSchema.Builder</a></li>
                                <li><a href="../classes/StoreValue.html">StoreValue</a></li>
                                <li><a href="../classes/StoreValue.Builder.html">StoreValue.Builder</a></li>
                                <li><a href="../classes/UpdateCounter.html">UpdateCounter</a></li>
                                <li><a href="../classes/UpdateCounter.Builder.html">UpdateCounter.Builder</a></li>
                                <li><a href="../classes/UpdateMap.html">UpdateMap</a></li>
                                <li><a href="../classes/UpdateMap.Builder.html">UpdateMap.Builder</a></li>
                                <li><a href="../classes/UpdateMap.MapOperation.html">UpdateMap.MapOperation</a></li>
                                <li><a href="../classes/UpdateSet.html">UpdateSet</a></li>
                                <li><a href="../classes/UpdateSet.Builder.html">UpdateSet.Builder</a></li>
                            </ul>
                
                
                            <ul id="api-modules" class="apis modules">
                                <li><a href="../modules/Client.html">Client</a></li>
                                <li><a href="../modules/Core.html">Core</a></li>
                                <li><a href="../modules/CRDT.html">CRDT</a></li>
                                <li><a href="../modules/KV.html">KV</a></li>
                                <li><a href="../modules/MR.html">MR</a></li>
                                <li><a href="../modules/TS.html">TS</a></li>
                                <li><a href="../modules/YZ.html">YZ</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: lib/commands/kv/riakobject.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
&#x27;use strict&#x27;;

var utils = require(&#x27;../../utils&#x27;);
var rpb = require(&#x27;../../protobuf/riakprotobuf&#x27;);
var RpbContent = rpb.getProtoFor(&#x27;RpbContent&#x27;);
var RpbPair = rpb.getProtoFor(&#x27;RpbPair&#x27;);
var RpbLink = rpb.getProtoFor(&#x27;RpbLink&#x27;);

/**
 * Provides the RiakObject class.
 * @module KV
 */

/**
 * A class that encapsulates the metadata and value stored in Riak.
 * 
 * While you can fetch and store regular JS objects with {{#crossLink &quot;FetchValue&quot;}}{{/crossLink}}
 * and {{#crossLink &quot;StoreValue&quot;}}{{/crossLink}}, if you want access to the associated 
 * metadata stored in Riak with the value you&#x27;ll want to use a RiakObject instead. 
 *
 * @class RiakObject
 * @constructor
 */
function RiakObject() {
    // default content type
    this.contentType = &#x27;application/json&#x27;;
}

RiakObject.prototype = {
    /**
     * Set the key.
     * @method setKey
     * @param {String} key the key in Riak.
     * @chainable
     */
    setKey : function(key) {
        this.key = key;
        return this;
    },
    /**
     * Get the key.
     * @method getKey
     * @return {String} the key.
     */
    getKey : function() {
        return this.key;
    },
    /**
     * Set the bucket.
     * @method setBucket
     * @param {String} bucket the bucket in Riak.
     * @chainable
     */
    setBucket : function(bucket) {
        this.bucket = bucket;
        return this;
    },
    /**
     * Get the bucket.
     * @method getBucket
     * @return {String} the bucket. 
     */
    getBucket : function() {
        return this.bucket;
    },
    /**
     * Set the bucket type.
     * 
     * If this is not set &#x27;default&#x27; is used.
     * @method setBucketType
     * @param {String} bucketType the bucket type in Riak.
     * @chainable
     */
    setBucketType : function(bucketType) {
        this.bucketType = bucketType;
        return this;
    },
    /**
     * Get the bucket type.
     * @method getBucketType
     * @return {String} the bucket type.
     */
    getBucketType : function() {
        return this.bucketType;  
    },
    /**
     * Set the value.
     * @method setValue
     * @param {String|Buffer|Object} value the value stored in Riak.
     * @chainable
     */
    setValue : function(value) {
        this.value = value;
        return this;
    },
    /**
     * Get the value.
     * 
     * This will either be a Buffer or a plain JS object.
     * @method getValue
     * @return {Buffer|Object} The value returned from Riak.
     */
    getValue : function() {
        return this.value;
    },
    /**
     * Set the content type.
     *  
     * Due to Riak&#x27;s HTTP API this is represented as a string suitable for
     * a HTTP Content-Type header. 
     * 
     * If not set, the default is &#x27;application/json&#x27;
     * @method setContentType
     * @param {String} contentType the content type.
     * @chainable
     */
    setContentType : function(contentType) {
        this.contentType = contentType;
        return this;
    },
    /**
     * Get the content type.
     * 
     * Due to Riak&#x27;s HTTP API this is represented as a string suitable for
     * a HTTP Content-Type header. 
     * @method getContentType
     * @return {String} the content type.
     */
    getContentType : function() {
        return this.contentType;
    },
    /**
     * Set the content encoding.
     *
     * @method setContentEncoding
     * @param {String} contentEncoding the content encoding
     * @chainable
     */
    setContentEncoding : function(contentEncoding) {
        this.contentEncoding = contentEncoding;
        return this;
    },
    /**
     * Get the content encoding
     *
     * @method getContentEncoding
     * @returns {String} the content encoding
     */
    getContentEncoding : function() {
        return this.contentEncoding;
    },
    /**
     * Set the user meta data.
     * 
     * This is an array of key/value objects.
     * @method setUserMeta
     * @param {Object[]} userMeta
     * @param {String} userMeta.key usermeta key
     * @param {String} userMeta.value usermeat value
     * @chainable
     */
    setUserMeta : function(userMeta) {
        this.userMeta = userMeta;
        return this;
    },
    /**
     * Determine if any user metadata is present.
     * @method hasUserMeta
     * @return {Boolean} true if user meta data is present.
     */
    hasUserMeta : function() {
        return this.userMeta !== undefined;
    },
    /**
     * Get the user meta data
     * 
     * This is an array of key/value objects
     * @method getUserMeta
     * @return {Object[]} array of key/value objects
     */
    getUserMeta : function() {
        return this.userMeta;
    },
    /**
     * Set an index, replacing the existing value if any.
     * @method setIndex
     * @param {String} indexName the index name
     * @param {String[]|Number[]} arrayOfKeys - the keys 
     * @chainable
     */
    setIndex : function(indexName, arrayOfKeys) {
        if (this.indexes === undefined) {
            this.indexes = {};
        }
        this.indexes[indexName] = arrayOfKeys;
        return this; 
    },
    /**
     * Determine if any indexes are present.
     * @method hasIndexes
     * @return {Boolean} true if indexes are present.
     */
    hasIndexes : function() {
        return this.indexes !== undefined;
    },
    /**
     * Get all indexes.
     *
     * @method getIndexes
     * @return {Object} an object whose fields are the index names holding arrays of keys
     */
    getIndexes : function() {
        return this.indexes;
    },
    /**
     * Get the keys for an index.
     * @method getIndex
     * @param {String} indexName the name of the index
     * @return {String[]} the keys 
     */
    getIndex : function(indexName) {
        if (this.indexes !== undefined) {
            return this.indexes[indexName];
        } else {
            return undefined;
        }
    },
    /**
     * Add one or more keys to an index.
     * 
     * If the index does not exist it will be created.
     * @method addToIndex
     * @param {String} indexName the index name
     * @param {String|Number} ...key 1 or more keys to add
     * @chainable
     */
    addToIndex : function(indexName, key) {
        if (this.indexes === undefined) {
            this.indexes = {};
        }
        if (!this.indexes.hasOwnProperty(indexName)) {
            this.indexes[indexName] = [];
        }
        for (var i = 1; i &lt; arguments.length; i++) {
            this.indexes[indexName].push(arguments[i]);
        }
        return this;
    },
    /**
     * Determine if any links are present.
     * 
     * Note that link walking is a deprecated feature in Riak 2.0.
     * 
     * See: [Link Walking](http://docs.basho.com/riak/latest/dev/using/link-walking/)
     * @method hasLinks
     * @return {Boolean} true if there are any links.
     * @deprecated Link walking is a deprecated feature in Riak 2.0.
     */
    hasLinks : function() {
        return this.links !== undefined;
    },
    /**
     * Get the links.
     * 
     * This is an array of objects representing links to other objects in Riak.
     * 
     * Note that link walking is a deprecated feature in Riak 2.0.
     * 
     * See: [Link Walking](http://docs.basho.com/riak/latest/dev/using/link-walking/)
     * @method getLinks
     * @return {Object[]} An array containing the links, or undefined if none exist.
     * @deprecated Link walking is a deprecated feature in Riak 2.0.
     */
    getLinks : function() {
        return this.links;
    },
    /**
     * Set the links.
     * 
     * This is an array of objects representing links to other objects in Riak.
     * 
     * Note that link walking is a deprecated feature in Riak 2.0.
     * 
     * See: [Link Walking](http://docs.basho.com/riak/latest/dev/using/link-walking/)
     * @method setLinks
     * @param {Object[]} links An array of objects representing the links.
     * @param {String} links.bucket The bucket the linked object is in.
     * @param {String} links.key The key for the linked object.
     * @param {String} links.tag The identifier that describes the relationship you are wishing to capture with your link
     * @chainable
     * @deprecated Link walking is a deprecated feature in Riak 2.0.
     */
    setLinks : function(links) {
        this.links = links;
        return this;
    },
    /**
     * Set the vector clock.
     * @method setVClock
     * @param {Buffer} vclock the vclock retrieved from Riak
     * @chainable
     */
    setVClock : function(vclock) {
        this.vclock = vclock;
        return this;
    },
    /**
     * Get the vector clock.
     * @method getVClock
     * @return {Buffer} The vector clock retrieved from Riak.
     */
    getVClock : function() {
        return this.vclock;
    },
    /**
     * Returns whether or not this RiakObject is marked as being deleted (a tombstone)
     * @method getIsTombstone
     * @return {Boolean} true if this is a tombstone.
     */
    getIsTombstone : function() {
        return this.isTombstone;
    },
    /**
     * Returns the last modified time of this RiakObject.
     * 
     * The timestamp is returned as a (Unix) epoch time. 
     * @method getLastModified
     * @return {Number} the last modified time. 
     */
    getLastModified : function() {
        return this.lastModified;
    }
};

module.exports = RiakObject;

module.exports.isRiakObject = function (v) {
    return v instanceof RiakObject;
};

module.exports.isIntIndex = function(indexName) {
    return indexName.indexOf(&#x27;_int&#x27;, indexName.length - 4) !== -1;
};

module.exports.createFromRpbContent = function(rpbContent, convertToJs) {
    var ro = new RiakObject();
    
    var value = rpbContent.getValue();
    
    ro.isTombstone = rpbContent.getDeleted() ? true : false;

    if (ro.isTombstone) {
        ro.value = {};
    } else {
        // ReturnHead will only retun metadata
        if (convertToJs &amp;&amp; value) {
            ro.value = JSON.parse(value.toString(&#x27;utf8&#x27;)); 
        } else if (value) {
            ro.value = value.toBuffer();
        }
    }
    
    if (rpbContent.getContentType()) {
        ro.contentType = rpbContent.getContentType().toString(&#x27;utf8&#x27;);
    }

    if (rpbContent.getContentEncoding()) {
        ro.contentEncoding = rpbContent.getContentEncoding().toString(&#x27;utf8&#x27;);
    }
    
    if (rpbContent.getLastMod()) {
        var lm = rpbContent.getLastMod();
        var lmu = rpbContent.getLastModUsecs();
        ro.lastModified = ((lm * 1000) + (lmu / 1000));
    }
    
    // UserMeta
    var pbUsermeta = rpbContent.getUsermeta();
    var usermeta = new Array(pbUsermeta.length);
    var i;
    for (i = 0; i &lt; pbUsermeta.length; i++) {
        usermeta[i] = { key: pbUsermeta[i].key.toString(&#x27;utf8&#x27;), 
            value: pbUsermeta[i].value.toString(&#x27;utf8&#x27;) };
    }
    ro.userMeta = usermeta;
    
    //indexes
    var pbIndexes = rpbContent.getIndexes();
    if (pbIndexes.length &gt; 0) {
        var indexes = {};
        for (i = 0; i &lt; pbIndexes.length; i++) {
            var indexName = pbIndexes[i].key.toString(&#x27;utf8&#x27;);
            if (!indexes.hasOwnProperty(indexName)) {
                indexes[indexName] = [];
            }
            var stringValue = pbIndexes[i].value.toString(&#x27;utf8&#x27;);
            if (RiakObject.isIntIndex(indexName)) {
                indexes[indexName].push(parseInt(stringValue));
            } else {
                indexes[indexName].push(stringValue);
            }
        }
        ro.indexes = indexes;
    }
    
    //links
    var pbLinks = rpbContent.getLinks();
    if (pbLinks.length) {
        var links = new Array(pbLinks.length);
        var link;
        for (i = 0; i &lt; pbLinks.length; i++) {
            link = {};
            if (pbLinks[i].bucket) {
                link.bucket = pbLinks[i].bucket.toString(&#x27;utf8&#x27;);
            }
            if (pbLinks[i].key) {
                link.key = pbLinks[i].key.toString(&#x27;utf8&#x27;);
            }
            if (pbLinks[i].tag) {
                link.tag = pbLinks[i].tag.toString(&#x27;utf8&#x27;);
            }
            links[i] = link;
        }
        ro.links = links;
    }
    
    return ro;
};

/**
 * Creates and returns a RpbContent protobuf from a value and meta.
 * 
 * If the value is a JS Object it is converted using JSON.stringify().
 * @private
 * @method populateRpbContentFromRiakObject
 * @static
 * @param {RiakObject} ro The RiakObject
 * @return {Object} a RpbContent protobuf
 */
module.exports.populateRpbContentFromRiakObject = function(ro) {
    var rpbContent = new RpbContent();
    
    if (utils.isString(ro.value)) {
        rpbContent.setValue(new Buffer(ro.value));
    } else if (Buffer.isBuffer(ro.value)) {
        rpbContent.setValue(ro.value);
    } else {
        rpbContent.setValue(new Buffer(JSON.stringify(ro.value)));
    }
    
    if (ro.getContentType()) {
        rpbContent.setContentType(new Buffer(ro.getContentType()));
    }

    if (ro.getContentEncoding()) {
        rpbContent.setContentEncoding(new Buffer(ro.getContentEncoding()));
    }

    var i, pair;
    if (ro.hasIndexes()) {
        var allIndexes = ro.getIndexes();
        for (var indexName in allIndexes) {
            var indexKeys = allIndexes[indexName];
            for (i = 0; i &lt; indexKeys.length; i++) {
                pair = new RpbPair();
                pair.setKey(new Buffer(indexName));
                // The Riak API expects string values, even for _int indexes
                pair.setValue(new Buffer(indexKeys[i].toString()));
                rpbContent.indexes.push(pair);
            }
        }
    }

    if (ro.hasUserMeta()) {
        var userMeta = ro.getUserMeta();
        for (i = 0; i &lt; userMeta.length; i++) {
            pair = new RpbPair();
            pair.setKey(new Buffer(userMeta[i].key));
            pair.setValue(new Buffer(userMeta[i].value));
            rpbContent.usermeta.push(pair);
        }
    }
    
    if (ro.hasLinks()) {
        var links = ro.getLinks();
        var pbLink;
        for (i = 0; i &lt; links.length; i++) {
            pbLink = new RpbLink();
            if (links[i].bucket) {
                pbLink.setBucket(new Buffer(links[i].bucket));
            }
            if (links[i].key) {
                pbLink.setKey(new Buffer(links[i].key));
            }
            if (links[i].tag) {
                pbLink.setTag(new Buffer(links[i].tag));
            }
            rpbContent.links.push(pbLink);
        }
    }
    return rpbContent;
};


    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
